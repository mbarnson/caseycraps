---
phase: 06-testing-accessibility
plan: 03
type: execute
domain: macos-apps
---

<objective>
Create AccessibleSKView foundation with proper NSAccessibilityElement hierarchy.

Purpose: SpriteKit nodes don't support NSAccessibility. We must create an accessibility overlay at the SKView level that VoiceOver can traverse.
Output: AccessibleSKView class with NSAccessibilityElement instances for all interactive game elements.
</objective>

<execution_context>
@~/.claude/skills/create-plans/workflows/execute-phase.md
@~/.claude/skills/create-plans/templates/summary.md
</execution_context>

<context>
@.planning/BRIEF.md
@.planning/ROADMAP.md
@Casey Craps/Casey Craps/GameScene.swift
@Casey Craps/Casey Craps/ViewController.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AccessibleSKView class</name>
  <files>Casey Craps/Casey Craps/AccessibleSKView.swift</files>
  <action>
    Create a new AccessibleSKView class that subclasses SKView and implements NSAccessibility:

    ```swift
    import SpriteKit
    import AppKit

    class AccessibleSKView: SKView {
        private var accessibilityElements: [NSAccessibilityElement] = []

        override func accessibilityChildren() -> [Any]? {
            return accessibilityElements
        }

        override func accessibilityHitTest(_ point: NSPoint) -> Any? {
            // Convert point to view coordinates and find element
            for element in accessibilityElements {
                if let frame = element.accessibilityFrame(),
                   frame.contains(point) {
                    return element
                }
            }
            return super.accessibilityHitTest(point)
        }

        override var isAccessibilityElement: Bool {
            get { return false }  // Container, not element
            set { }
        }

        func updateAccessibilityElements(_ elements: [NSAccessibilityElement]) {
            self.accessibilityElements = elements
            NSAccessibility.post(element: self, notification: .layoutChanged)
        }
    }
    ```

    Key points:
    - Override accessibilityChildren() to return our custom elements
    - Override accessibilityHitTest() for point-based VoiceOver navigation
    - Provide updateAccessibilityElements() for GameScene to call when state changes
  </action>
  <verify>xcodebuild -project "Casey Craps/Casey Craps.xcodeproj" -scheme "Casey Craps" build 2>&1 | tail -5</verify>
  <done>AccessibleSKView compiles, has accessibilityChildren and accessibilityHitTest methods</done>
</task>

<task type="auto">
  <name>Task 2: Create NSAccessibilityElement instances for game elements</name>
  <files>Casey Craps/Casey Craps/AccessibleSKView.swift</files>
  <action>
    Add a GameAccessibilityManager class (or extension) that creates NSAccessibilityElement instances:

    ```swift
    class GameAccessibilityManager {
        weak var view: AccessibleSKView?

        // Element references for updates
        var diceElement: NSAccessibilityElement?
        var passLineElement: NSAccessibilityElement?
        var dontPassElement: NSAccessibilityElement?
        var pointElements: [Int: NSAccessibilityElement] = [:]  // 4,5,6,8,9,10
        var betButtonElements: [NSAccessibilityElement] = []
        var bankrollElement: NSAccessibilityElement?

        func createElements(for view: AccessibleSKView, gameScene: GameScene) {
            self.view = view
            var elements: [NSAccessibilityElement] = []

            // Dice (combined as single clickable element)
            let dice = NSAccessibilityElement()
            dice.setAccessibilityParent(view)
            dice.setAccessibilityRole(.button)
            dice.setAccessibilityLabel("Dice")
            dice.setAccessibilityHelp("Double-click to roll dice")
            // Frame will be set by updateFrames()
            diceElement = dice
            elements.append(dice)

            // Pass Line
            let passLine = NSAccessibilityElement()
            passLine.setAccessibilityParent(view)
            passLine.setAccessibilityRole(.button)
            passLine.setAccessibilityLabel("Pass Line bet area")
            passLine.setAccessibilityHelp("Double-click to place Pass Line bet")
            passLineElement = passLine
            elements.append(passLine)

            // Don't Pass
            let dontPass = NSAccessibilityElement()
            dontPass.setAccessibilityParent(view)
            dontPass.setAccessibilityRole(.button)
            dontPass.setAccessibilityLabel("Don't Pass bet area")
            dontPass.setAccessibilityHelp("Double-click to place Don't Pass bet")
            dontPassElement = dontPass
            elements.append(dontPass)

            // Point numbers (4, 5, 6, 8, 9, 10)
            let pointNumbers = [4, 5, 6, 8, 9, 10]
            let odds = [4: "9 to 5", 5: "7 to 5", 6: "7 to 6", 8: "7 to 6", 9: "7 to 5", 10: "9 to 5"]
            for num in pointNumbers {
                let point = NSAccessibilityElement()
                point.setAccessibilityParent(view)
                point.setAccessibilityRole(.button)
                point.setAccessibilityLabel("Place bet on \(num)")
                point.setAccessibilityHelp("Double-click to place bet, pays \(odds[num]!)")
                pointElements[num] = point
                elements.append(point)
            }

            // Bet amount buttons ($25, $50, $100, etc.)
            // These will be created based on actual buttons in GameScene

            // Bankroll display (read-only)
            let bankroll = NSAccessibilityElement()
            bankroll.setAccessibilityParent(view)
            bankroll.setAccessibilityRole(.staticText)
            bankroll.setAccessibilityLabel("Bankroll")
            bankrollElement = bankroll
            elements.append(bankroll)

            view.updateAccessibilityElements(elements)
        }

        func updateFrames(from gameScene: GameScene) {
            // Convert SKNode positions to screen coordinates
            // This requires gameScene.view and coordinate conversion
        }
    }
    ```

    Create elements for:
    - Dice (single element for both dice)
    - Pass Line betting area
    - Don't Pass betting area
    - Each point number (4, 5, 6, 8, 9, 10)
    - Bankroll display (read-only)
  </action>
  <verify>xcodebuild -project "Casey Craps/Casey Craps.xcodeproj" -scheme "Casey Craps" build 2>&1 | tail -5</verify>
  <done>GameAccessibilityManager creates NSAccessibilityElement for each interactive element</done>
</task>

<task type="auto">
  <name>Task 3: Wire up ViewController with AccessibleSKView</name>
  <files>Casey Craps/Casey Craps/ViewController.swift, Casey Craps/Casey Craps/GameScene.swift</files>
  <action>
    1. In ViewController.swift:
       - Change the SKView outlet to AccessibleSKView (or cast it)
       - Initialize GameAccessibilityManager
       - After presenting GameScene, call createElements()

    2. In GameScene.swift:
       - Add a reference to GameAccessibilityManager
       - Add method to provide node positions for frame calculation
       - Call updateFrames() after layout changes

    3. Implement coordinate conversion:
       - SKNode positions are in scene coordinates
       - NSAccessibilityElement frames must be in screen coordinates
       - Use view.convert() and window.convertToScreen()

    ```swift
    // In ViewController
    var accessibilityManager: GameAccessibilityManager?

    override func viewDidLoad() {
        super.viewDidLoad()

        if let view = self.view as? AccessibleSKView {
            // ... existing scene setup ...

            accessibilityManager = GameAccessibilityManager()
            accessibilityManager?.createElements(for: view, gameScene: scene)
        }
    }
    ```

    Note: The Main.storyboard may need the SKView's class changed to AccessibleSKView,
    OR create AccessibleSKView programmatically and replace the view.
  </action>
  <verify>xcodebuild -project "Casey Craps/Casey Craps.xcodeproj" -scheme "Casey Craps" build && echo "BUILD SUCCEEDED"</verify>
  <done>App builds, AccessibleSKView is used, GameAccessibilityManager is initialized</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `xcodebuild build` succeeds
- [ ] AccessibleSKView class exists and compiles
- [ ] GameAccessibilityManager creates all accessibility elements
- [ ] ViewController uses AccessibleSKView
- [ ] App launches without crashes
</verification>

<success_criteria>
- AccessibleSKView implements accessibilityChildren() and accessibilityHitTest()
- NSAccessibilityElement created for: dice, Pass Line, Don't Pass, 6 point numbers, bankroll
- Elements have appropriate roles, labels, and help text
- App builds and runs
</success_criteria>

<output>
After completion, create `.planning/phases/06-testing-accessibility/06-03-SUMMARY.md`
</output>
