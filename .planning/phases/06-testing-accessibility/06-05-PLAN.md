---
phase: 06-testing-accessibility
plan: 05
type: execute
domain: macos-apps
---

<objective>
Sync accessibility state with game state and add visual feedback for hearing-impaired users.

Purpose: Accessibility labels must update as game state changes. Hearing-impaired users need visual alternatives for audio cues.
Output: Dynamic accessibility labels and visual feedback for all audio events.
</objective>

<execution_context>
@~/.claude/skills/create-plans/workflows/execute-phase.md
@~/.claude/skills/create-plans/templates/summary.md
@~/.claude/skills/create-plans/references/checkpoints.md
</execution_context>

<context>
@.planning/BRIEF.md
@.planning/ROADMAP.md
@.planning/phases/06-testing-accessibility/06-04-SUMMARY.md
@Casey Craps/Casey Craps/AccessibleSKView.swift
@Casey Craps/Casey Craps/GameScene.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Sync accessibility labels with game state</name>
  <files>Casey Craps/Casey Craps/AccessibleSKView.swift, Casey Craps/Casey Craps/GameScene.swift</files>
  <action>
    Update accessibility labels dynamically as game state changes:

    1. In GameAccessibilityManager, add update methods:
       ```swift
       func updateDiceLabel(die1: Int, die2: Int, canRoll: Bool) {
           let total = die1 + die2
           diceElement?.setAccessibilityLabel("Dice showing \(die1) and \(die2), total \(total)")
           if canRoll {
               diceElement?.setAccessibilityHelp("Double-click to roll dice")
           } else {
               diceElement?.setAccessibilityHelp("Cannot roll now")
           }
       }

       func updatePassLineLabel(betAmount: Int?) {
           if let amount = betAmount {
               passLineElement?.setAccessibilityLabel("Pass Line bet area, $\(amount) bet placed")
           } else {
               passLineElement?.setAccessibilityLabel("Pass Line bet area, no bet")
           }
       }

       func updatePointLabel(number: Int, isCurrentPoint: Bool, betAmount: Int?) {
           var label = "Place bet on \(number)"
           if isCurrentPoint {
               label = "Current point: \(number)"
           }
           if let amount = betAmount {
               label += ", $\(amount) bet placed"
           }
           pointElements[number]?.setAccessibilityLabel(label)
       }

       func updateBankrollLabel(amount: Int) {
           bankrollElement?.setAccessibilityLabel("Bankroll: $\(amount)")
       }
       ```

    2. In GameScene, call updates at appropriate times:
       - After dice roll completes: updateDiceLabel()
       - After bet placed: updatePassLineLabel(), updatePointLabel()
       - After bet resolved: update all bet labels
       - After point established: update point labels with "Current point"
       - After bankroll changes: updateBankrollLabel()

    3. Post accessibility notifications for major state changes:
       ```swift
       NSAccessibility.post(element: view, notification: .announcementRequested,
                           userInfo: [.announcement: "Point is 6"])
       ```

    4. Keep existing announceRollResult(), announceBetPlaced(), announceBetResolved() methods
       (these use NSAccessibility.post which works correctly)
  </action>
  <verify>xcodebuild -project "Casey Craps/Casey Craps.xcodeproj" -scheme "Casey Craps" build 2>&1 | tail -5</verify>
  <done>Accessibility labels update dynamically, VoiceOver announces current state correctly</done>
</task>

<task type="auto">
  <name>Task 2: Add visual feedback for audio events</name>
  <files>Casey Craps/Casey Craps/GameScene.swift</files>
  <action>
    Create visual alternatives for all audio cues (helps hearing-impaired users):

    1. Win event visual feedback:
       ```swift
       private func showWinFeedback(amount: Int) {
           // Flash border green
           let flash = SKShapeNode(rectOf: CGSize(width: 980, height: 740))
           flash.strokeColor = .green
           flash.lineWidth = 8
           flash.fillColor = .clear
           flash.zPosition = 900
           addChild(flash)

           // Floating "+$amount" text
           let winText = SKLabelNode(text: "+$\(amount)")
           winText.fontSize = 48
           winText.fontColor = .green
           winText.fontName = "Arial-BoldMT"
           winText.position = CGPoint(x: 0, y: 0)
           winText.zPosition = 901
           addChild(winText)

           // Animate: rise and fade
           let rise = SKAction.moveBy(x: 0, y: 100, duration: 1.5)
           let fade = SKAction.fadeOut(withDuration: 1.5)
           let remove = SKAction.removeFromParent()
           winText.run(SKAction.sequence([SKAction.group([rise, fade]), remove]))

           // Flash fade
           flash.run(SKAction.sequence([
               SKAction.fadeOut(withDuration: 0.5),
               remove
           ]))
       }
       ```

    2. Lose event visual feedback:
       ```swift
       private func showLoseFeedback(betType: String) {
           // Flash border red
           let flash = SKShapeNode(rectOf: CGSize(width: 980, height: 740))
           flash.strokeColor = .red
           flash.lineWidth = 8
           flash.fillColor = .clear
           flash.zPosition = 900
           addChild(flash)

           // Floating "Lost [bet]" text
           let loseText = SKLabelNode(text: "Lost \(betType)")
           loseText.fontSize = 36
           loseText.fontColor = .red
           loseText.fontName = "Arial-BoldMT"
           loseText.position = CGPoint(x: 0, y: 0)
           loseText.zPosition = 901
           addChild(loseText)

           // Animate: sink and fade
           let sink = SKAction.moveBy(x: 0, y: -50, duration: 1.0)
           let fade = SKAction.fadeOut(withDuration: 1.0)
           let remove = SKAction.removeFromParent()
           loseText.run(SKAction.sequence([SKAction.group([sink, fade]), remove]))
           flash.run(SKAction.sequence([SKAction.fadeOut(withDuration: 0.5), remove]))
       }
       ```

    3. Point established visual feedback:
       ```swift
       private func showPointEstablished(point: Int) {
           // Flash the point number box gold
           if let boxPosition = crapsTable.getPointBoxPosition(number: point) {
               let highlight = SKShapeNode(rectOf: CGSize(width: 90, height: 70), cornerRadius: 8)
               highlight.position = boxPosition
               highlight.fillColor = SKColor(red: 1.0, green: 0.84, blue: 0, alpha: 0.5)
               highlight.strokeColor = .clear
               highlight.zPosition = 50
               crapsTable.addChild(highlight)

               let flash = SKAction.sequence([
                   SKAction.fadeIn(withDuration: 0.2),
                   SKAction.fadeOut(withDuration: 0.2)
               ])
               highlight.run(SKAction.sequence([
                   SKAction.repeat(flash, count: 3),
                   SKAction.removeFromParent()
               ]))
           }
       }
       ```

    4. Integrate into existing game flow:
       - Call showWinFeedback() when any bet wins
       - Call showLoseFeedback() when any bet loses
       - Call showPointEstablished() when point is set

    These visuals should ALWAYS appear (not just when sound is muted) to provide redundant feedback.
  </action>
  <verify>xcodebuild -project "Casey Craps/Casey Craps.xcodeproj" -scheme "Casey Craps" build && echo "BUILD SUCCEEDED"</verify>
  <done>Win shows green flash + floating text, lose shows red flash, point shows gold flash</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Dynamic accessibility labels and visual feedback for audio events</what-built>
  <how-to-verify>
    1. Build and run the app

    **Test dynamic accessibility updates with VoiceOver:**
    2. Enable VoiceOver (Cmd+F5)
    3. Navigate to dice - should announce current values
    4. Place a Pass Line bet - navigate to Pass Line, should say "$X bet placed"
    5. Roll dice - dice label should update with new values
    6. If point established - point number should announce "Current point: X"
    7. Navigate to bankroll - should announce current amount

    **Test visual feedback (can test with VoiceOver off):**
    8. Play until you win - verify:
       - Green border flash appears
       - "+$X" text floats up and fades
    9. Play until you lose - verify:
       - Red border flash appears
       - "Lost [bet type]" text appears and fades
    10. On come-out roll that establishes point - verify:
        - Point number box flashes gold 3 times
    11. Mute system audio and play a few rounds:
        - Can you follow the game state purely from visual feedback?

    Disable VoiceOver when done (Cmd+F5)
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `xcodebuild build` succeeds
- [ ] Accessibility labels update when game state changes
- [ ] Win/lose/point events have clear visual feedback
- [ ] Game is playable with audio muted
- [ ] All existing tests still pass
</verification>

<success_criteria>
- Accessibility labels reflect current game state
- VoiceOver announces state changes correctly
- Visual feedback for all audio events
- Game playable without sound
- User confirms accessibility and visual feedback work
</success_criteria>

<output>
After completion, create `.planning/phases/06-testing-accessibility/06-05-SUMMARY.md`
</output>
