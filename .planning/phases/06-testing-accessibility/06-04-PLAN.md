---
phase: 06-testing-accessibility
plan: 04
type: execute
domain: macos-apps
---

<objective>
Add keyboard navigation and visual focus indicator for VoiceOver users.

Purpose: VoiceOver users rely on keyboard navigation. We need Tab/arrow key support and visual focus feedback.
Output: Full keyboard navigation with visible focus ring, verified working with VoiceOver.
</objective>

<execution_context>
@~/.claude/skills/create-plans/workflows/execute-phase.md
@~/.claude/skills/create-plans/templates/summary.md
@~/.claude/skills/create-plans/references/checkpoints.md
</execution_context>

<context>
@.planning/BRIEF.md
@.planning/ROADMAP.md
@.planning/phases/06-testing-accessibility/06-03-SUMMARY.md
@Casey Craps/Casey Craps/AccessibleSKView.swift
@Casey Craps/Casey Craps/GameScene.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add keyboard navigation</name>
  <files>Casey Craps/Casey Craps/GameScene.swift, Casey Craps/Casey Craps/AccessibleSKView.swift</files>
  <action>
    Implement keyboard handling for accessibility navigation:

    1. In GameScene, override keyDown(with:):
       ```swift
       override func keyDown(with event: NSEvent) {
           switch event.keyCode {
           case 48:  // Tab
               if event.modifierFlags.contains(.shift) {
                   focusPreviousElement()
               } else {
                   focusNextElement()
               }
           case 49:  // Space
               activateFocusedElement()
           case 36:  // Return/Enter
               activateFocusedElement()
           case 123: // Left arrow
               focusPreviousInGroup()
           case 124: // Right arrow
               focusNextInGroup()
           case 125: // Down arrow
               focusNextElement()
           case 126: // Up arrow
               focusPreviousElement()
           case 53:  // Escape
               clearFocus()
           default:
               super.keyDown(with: event)
           }
       }
       ```

    2. Define focus order (logical navigation sequence):
       - Dice
       - Pass Line
       - Don't Pass
       - Point numbers (4, 5, 6, 8, 9, 10)
       - Bet amount buttons (if visible)

    3. Track current focus:
       ```swift
       enum FocusableElement: CaseIterable {
           case dice
           case passLine
           case dontPass
           case point4, point5, point6, point8, point9, point10
       }

       private var currentFocus: FocusableElement?
       ```

    4. Implement focus cycling:
       - Tab: move to next element in order
       - Shift+Tab: move to previous
       - Arrow keys: navigate within groups (e.g., between point numbers)

    5. Implement activateFocusedElement():
       - Dice: trigger roll (if allowed)
       - Betting areas: place bet (if allowed)
  </action>
  <verify>xcodebuild -project "Casey Craps/Casey Craps.xcodeproj" -scheme "Casey Craps" build 2>&1 | tail -5</verify>
  <done>Tab/Shift-Tab cycles focus, Space/Enter activates, arrow keys work within groups</done>
</task>

<task type="auto">
  <name>Task 2: Add visual focus indicator</name>
  <files>Casey Craps/Casey Craps/GameScene.swift</files>
  <action>
    Create a visible focus ring that highlights the currently focused element:

    1. Create focus indicator node:
       ```swift
       private var focusRing: SKShapeNode?

       private func setupFocusRing() {
           focusRing = SKShapeNode()
           focusRing?.strokeColor = NSColor.keyboardFocusIndicatorColor
           focusRing?.lineWidth = 3
           focusRing?.fillColor = .clear
           focusRing?.zPosition = 1000  // Above everything
           focusRing?.isHidden = true
           addChild(focusRing!)
       }
       ```

    2. Update focus ring position when focus changes:
       ```swift
       private func updateFocusRing(for element: FocusableElement) {
           guard let focusRing = focusRing else { return }

           let frame: CGRect
           switch element {
           case .dice:
               // Get bounding box around both dice
               frame = getDiceBounds()
           case .passLine:
               frame = crapsTable.getPassLineFrame()
           case .dontPass:
               frame = crapsTable.getDontPassFrame()
           case .point4, .point5, .point6, .point8, .point9, .point10:
               let number = pointNumber(for: element)
               frame = crapsTable.getPointBoxFrame(number: number)
           }

           // Create rounded rect path
           let path = CGPath(roundedRect: frame.insetBy(dx: -4, dy: -4),
                            cornerWidth: 8, cornerHeight: 8, transform: nil)
           focusRing.path = path
           focusRing.isHidden = false
       }

       private func clearFocus() {
           currentFocus = nil
           focusRing?.isHidden = true
       }
       ```

    3. Use system focus color (NSColor.keyboardFocusIndicatorColor) for accessibility compliance

    4. Add helper methods to CrapsTableNode if needed:
       - getPassLineFrame() -> CGRect
       - getDontPassFrame() -> CGRect
       - getPointBoxFrame(number:) -> CGRect
  </action>
  <verify>xcodebuild -project "Casey Craps/Casey Craps.xcodeproj" -scheme "Casey Craps" build && echo "BUILD SUCCEEDED"</verify>
  <done>Focus ring visible when navigating with keyboard, uses system focus color</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Keyboard navigation with visual focus indicator and VoiceOver integration</what-built>
  <how-to-verify>
    1. Build and run: `xcodebuild -scheme "Casey Craps" build` then open the app

    **Test keyboard navigation (without VoiceOver first):**
    2. Press Tab - focus ring should appear on dice
    3. Press Tab again - focus should move to Pass Line
    4. Continue Tab - should cycle through: Don't Pass → Point 4 → 5 → 6 → 8 → 9 → 10
    5. Press Shift+Tab - should go backwards
    6. Press Space or Enter on Pass Line - should place bet (if in betting state)
    7. Press Space on dice - should roll (if roll is allowed)
    8. Press Escape - focus ring should disappear

    **Test with VoiceOver:**
    9. Enable VoiceOver (Cmd+F5)
    10. Press VO+Right Arrow (Ctrl+Option+Right) to navigate
    11. VoiceOver should announce each element: "Dice, button", "Pass Line bet area, button", etc.
    12. Press VO+Space to activate elements
    13. Verify announcements are spoken for:
        - Element names and roles
        - Bet placement
        - Roll results
    14. Disable VoiceOver (Cmd+F5)
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `xcodebuild build` succeeds
- [ ] Tab/Shift-Tab cycles through all focusable elements
- [ ] Space/Enter activates the focused element
- [ ] Focus ring is visible and follows focus
- [ ] VoiceOver can navigate and announce elements
</verification>

<success_criteria>
- Full keyboard navigation implemented
- Visual focus ring matches system focus color
- VoiceOver announces all interactive elements
- User confirms keyboard and VoiceOver navigation works
</success_criteria>

<output>
After completion, create `.planning/phases/06-testing-accessibility/06-04-SUMMARY.md`
</output>
