---
phase: 03-game-logic
plan: 03
type: execute
domain: macos-apps
---

<objective>
Implement point phase logic and complete game flow.

Purpose: Handle rolls after point is established - hit point to win, seven-out to lose.
Output: Complete playable craps game with full betting cycle.
</objective>

<execution_context>
@~/.claude/skills/create-plans/workflows/execute-phase.md
@~/.claude/skills/create-plans/templates/summary.md
@~/.claude/skills/create-plans/references/checkpoints.md
</execution_context>

<context>
@.planning/BRIEF.md
@.planning/ROADMAP.md
@.planning/phases/03-game-logic/03-02-SUMMARY.md
@Casey Craps/Casey Craps/GameScene.swift
@Casey Craps/Casey Craps/GameManager.swift
@Casey Craps/Casey Craps/Models.swift
@Casey Craps/Casey Craps/CrapsTableNode.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Handle point phase rolls</name>
  <files>Casey Craps/Casey Craps/GameManager.swift</files>
  <action>
1. In GameManager.roll(), when state is .point(let pointValue):

   Pass Line bet:
   - Roll equals point: WIN - player.winBet(), state = .resolved(won: true)
   - Roll equals 7: LOSE (seven-out) - player.loseBet(), state = .resolved(won: false)
   - Any other roll: keep rolling (no state change, stay in point phase)

   Don't Pass bet:
   - Roll equals point: LOSE - player.loseBet(), state = .resolved(won: false)
   - Roll equals 7: WIN - player.winBet(), state = .resolved(won: true)
   - Any other roll: keep rolling

2. Console output for clarity:
   - "Rolled [X] - Point is [Y], keep rolling"
   - "Rolled [point]! You hit the point - WIN!"
   - "Seven out! You lose."

3. The resolved state triggers UI update (bankroll, feedback)
  </action>
  <verify>xcodebuild -project "Casey Craps/Casey Craps.xcodeproj" -scheme "Casey Craps" build 2>&1 | tail -10</verify>
  <done>Point phase correctly handles hitting point (win) and seven-out (lose)</done>
</task>

<task type="auto">
  <name>Task 2: Reset game after resolution</name>
  <files>Casey Craps/Casey Craps/GameScene.swift, Casey Craps/Casey Craps/GameManager.swift</files>
  <action>
1. After a roll resolves (win or lose), game needs to reset for next round:
   - Brief delay to show outcome (1-2 seconds)
   - Then call gameManager.reset()
   - reset() sets state back to .waitingForBet, clears pointValue

2. In GameScene, when resolution detected:
   - Show outcome feedback (text label: "WIN!" or "LOSE" or "SEVEN OUT!")
   - Wait 1.5 seconds (SKAction.wait)
   - Remove bet chip from table
   - Hide/remove outcome label
   - Reset puck to OFF position: crapsTable.setPuckPosition(point: nil)
   - Update bankroll display
   - Player can now place new bet

3. Handle edge case: player runs out of money
   - If bankroll < minimum bet ($100), show "Game Over" or "Out of chips"
   - For now, just let them see $0 and can't place bet
  </action>
  <verify>xcodebuild -project "Casey Craps/Casey Craps.xcodeproj" -scheme "Casey Craps" build 2>&1 | tail -10</verify>
  <done>Game resets after win/lose, ready for new bet, puck shows OFF</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete playable craps game with betting, come-out, and point phases</what-built>
  <how-to-verify>
    1. Run the app (Cmd+R)
    2. Verify bankroll shows $1,000
    3. Click Pass Line to place $100 bet - chip appears, bankroll shows $900
    4. Click Roll Dice
    5. Test come-out outcomes (may need multiple games):
       - 7 or 11: Should win immediately, get $200 back ($1,100 total)
       - 2, 3, or 12: Should lose immediately, stay at $900
       - Other number: Point established, puck moves to that number
    6. If point established, keep rolling:
       - Roll the point number: Win!
       - Roll 7: Seven out, lose
       - Other numbers: Keep rolling
    7. After win/lose, game should reset - puck OFF, can place new bet
    8. Try Don't Pass bet - outcomes should be opposite
    9. Verify bankroll updates correctly throughout
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] xcodebuild build succeeds with no errors
- [ ] Complete betting cycle works (bet → roll → outcome → reset)
- [ ] Come-out roll works correctly
- [ ] Point phase works correctly (hit point or seven-out)
- [ ] Bankroll tracks correctly
- [ ] Puck updates correctly (ON/OFF)
- [ ] Both Pass and Don't Pass bets work
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Human verified complete game flow
- Phase 3 complete: playable craps game
</success_criteria>

<output>
After completion, create `.planning/phases/03-game-logic/03-03-SUMMARY.md`

This completes Phase 3. Ready for Phase 4: Audio.
</output>
