---
phase: 03-game-logic
plan: 02
type: execute
domain: macos-apps
---

<objective>
Implement come-out roll logic with proper craps rules.

Purpose: Handle the first roll after betting - natural wins, craps losses, point establishment.
Output: Working come-out roll that pays wins, takes losses, or sets point.
</objective>

<execution_context>
@~/.claude/skills/create-plans/workflows/execute-phase.md
@~/.claude/skills/create-plans/templates/summary.md
</execution_context>

<context>
@.planning/BRIEF.md
@.planning/ROADMAP.md
@.planning/phases/03-game-logic/03-01-SUMMARY.md
@Casey Craps/Casey Craps/GameScene.swift
@Casey Craps/Casey Craps/GameManager.swift
@Casey Craps/Casey Craps/Models.swift
@Casey Craps/Casey Craps/CrapsTableNode.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire dice roll to GameManager</name>
  <files>Casey Craps/Casey Craps/GameScene.swift, Casey Craps/Casey Craps/GameManager.swift</files>
  <action>
1. In GameScene mouseDown (roll button handler):
   - After dice animation completes, call gameManager.roll(die1: value1, die2: value2)
   - The roll() method handles all game logic based on current state

2. In GameManager.roll():
   - The method already exists from Phase 1
   - Verify it switches on current state (.comeOut vs .point)
   - For .comeOut state, implement come-out logic (Task 2)
   - Return or publish the outcome for UI to react

3. Add a way for GameScene to know the outcome:
   - Option A: GameManager publishes outcome via @Published
   - Option B: roll() returns an enum (RollOutcome: win, lose, pointEstablished, rolling)
   - Choose simpler option - probably return value or callback
  </action>
  <verify>xcodebuild -project "Casey Craps/Casey Craps.xcodeproj" -scheme "Casey Craps" build 2>&1 | tail -10</verify>
  <done>Dice roll calls GameManager.roll(), state transitions occur</done>
</task>

<task type="auto">
  <name>Task 2: Implement come-out roll outcomes</name>
  <files>Casey Craps/Casey Craps/GameManager.swift, Casey Craps/Casey Craps/GameScene.swift</files>
  <action>
1. In GameManager, handle come-out roll (state == .comeOut):

   Pass Line bet rules:
   - 7 or 11: WIN (natural) - player.winBet(), state = .resolved(won: true)
   - 2, 3, or 12: LOSE (craps) - player.loseBet(), state = .resolved(won: false)
   - 4, 5, 6, 8, 9, 10: POINT ESTABLISHED - state = .point(total), pointValue = total

   Don't Pass bet rules:
   - 7 or 11: LOSE - player.loseBet(), state = .resolved(won: false)
   - 2 or 3: WIN - player.winBet(), state = .resolved(won: true)
   - 12: PUSH (bar 12) - player.pushBet(), state = .resolved(won: false) or special push state
   - 4, 5, 6, 8, 9, 10: POINT ESTABLISHED (same as pass)

2. In GameScene, after roll completes:
   - Check gameManager.state
   - If .resolved(won: true): show win feedback, update bankroll display
   - If .resolved(won: false): show lose feedback, update bankroll display
   - If .point(_): update puck position (Task 3)
   - Remove bet chip on win/lose (or keep for point phase)

3. Print outcome to console for debugging
  </action>
  <verify>xcodebuild -project "Casey Craps/Casey Craps.xcodeproj" -scheme "Casey Craps" build 2>&1 | tail -10</verify>
  <done>Come-out roll correctly handles 7/11, 2/3/12, and point establishment</done>
</task>

<task type="auto">
  <name>Task 3: Update puck when point established</name>
  <files>Casey Craps/Casey Craps/GameScene.swift, Casey Craps/Casey Craps/CrapsTableNode.swift</files>
  <action>
1. When roll results in point establishment:
   - Get the point value from gameManager (4, 5, 6, 8, 9, or 10)
   - Call crapsTable.setPuckPosition(point: pointValue)
   - Puck should move from OFF to ON position over that number

2. In CrapsTableNode.setPuckPosition():
   - If point is nil: show puck as "OFF" (or hide it)
   - If point is a number: position puck over that number box, show as "ON"
   - Puck appearance: white circle with "ON" or "OFF" text, or just positioned indicator

3. Visual feedback for point establishment:
   - Brief highlight or pulse on the point number
   - Console log: "Point is [number]"

4. Keep bet chip in place - bet carries through to point phase
  </action>
  <verify>xcodebuild -project "Casey Craps/Casey Craps.xcodeproj" -scheme "Casey Craps" build 2>&1 | tail -10</verify>
  <done>Puck moves to point number when point established, displays ON</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] xcodebuild build succeeds with no errors
- [ ] Rolling 7 or 11 on come-out wins (Pass) / loses (Don't Pass)
- [ ] Rolling 2, 3, 12 on come-out loses (Pass) / wins or pushes (Don't Pass)
- [ ] Rolling 4,5,6,8,9,10 establishes point
- [ ] Puck moves to point number and shows ON
- [ ] Bankroll updates correctly on win/lose
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No compiler errors
- Come-out roll works correctly per craps rules
</success_criteria>

<output>
After completion, create `.planning/phases/03-game-logic/03-02-SUMMARY.md`
</output>
